name: Unit and integration tests

on:
  workflow_call:
    inputs:
      node-version:
        type: string
        required: true

jobs:
  build_and_test:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:latest
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: test_db
          MYSQL_USER: test_user
          MYSQL_PASSWORD: test_pass

        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h 127.0.0.1 --silent"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    env:
      DB_NAME: test_db
      DB_USER: test_user
      DB_PASSWORD: test_pass
      DB_HOST: 127.0.0.1
      DB_DIALECT: mysql
      FIRST_USER_EMAIL: test@test.com
      FIRST_USER_PASSWORD: admin

    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Cr√©ation des fichiers de cl√©s RSA
        run: |
          mkdir -p keys
          echo "${{ secrets.PRIVATE_KEY }}" > keys/rsa.key
          echo "${{ secrets.PUBLIC_KEY }}" > keys/rsa.key.pub
          chmod 600 keys/rsa.key keys/rsa.key.pub

      - name: V√©rification du contenu des cl√©s RSA
        run: |
          echo "üîç Affichage des cl√©s RSA..."
          ls -l keys
          cat keys/rsa.key
          cat keys/rsa.key.pub

      - name: Installation de pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Installation des d√©pendances
        run: pnpm install

      - name: Attente de la disponibilit√© de MySQL
        run: |
          echo " Attente de la connexion √† MySQL..."
          until mysqladmin ping -h 127.0.0.1 --silent; do
            echo "MySQL pas encore pr√™t... attente 2s"
            sleep 2
          done
          echo " MySQL est pr√™t !"

      - name: V√©rification de la connexion MySQL avec Sequelize
        run: |
          node -e "
          const { Sequelize } = require('sequelize');
          const sequelize = new Sequelize(
            process.env.DB_NAME,
            process.env.DB_USER,
            process.env.DB_PASSWORD,
            { host: process.env.DB_HOST, dialect: process.env.DB_DIALECT }
          );
          sequelize.authenticate()
            .then(() => console.log(' Connexion Sequelize r√©ussie'))
            .catch(err => { console.error(' Connexion Sequelize √©chou√©e', err); process.exit(1); });
          "

      - name: Ex√©cution des migrations
        run: pnpx sequelize-cli db:migrate

      - name: Run seeders
        run: pnpx sequelize-cli db:seed:all

      - name: Ex√©cution des tests unitaires et d'int√©gration avec couverture
        run: pnpm run test:cov

      - name: Upload des r√©sultats des tests
        uses: actions/upload-artifact@v4
        with:
          name: vitest-tests-result
          path: tests-result/vitest
          include-hidden-files: true
          retention-days: 3

      - name: Upload des fichiers de couverture
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: coverage
          include-hidden-files: true
          retention-days: 3
